---
title: æ™ºèƒ½æŒ‡é’ˆç®€ä»‹
date: 2025-11-19 10:58:00
categories: ç¼–ç¨‹è¯­è¨€
tags: C++
---

> æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆï¼Œåç»­ä¼šå•ç‹¬å¯¹æ¯ç§æ™ºèƒ½æŒ‡é’ˆåšå‡ºè¯¦ç»†ä»‹ç»ï¼Œå¹¶ç»™å‡ºæºç å®ç° ã€‚

> Q: æ™ºèƒ½æŒ‡é’ˆçš„åŸç†ä¸åŒºåˆ«ï¼ˆ`unique_ptr` / `shared_ptr` / `weak_ptr`ï¼‰ï¼Œå¾ªç¯å¼•ç”¨å¦‚ä½•è§£å†³ï¼Ÿ
>
> A: æ™ºèƒ½æŒ‡é’ˆä½¿ç”¨ RAII æœºåˆ¶ï¼Œç”¨äºè‡ªåŠ¨ç®¡ç†å †å†…å­˜ã€‚å®ƒçš„åŸç†æ˜¯ï¼šåœ¨å¯¹è±¡é”€æ¯æ—¶ï¼Œæ™ºèƒ½æŒ‡é’ˆçš„ææ„å‡½æ•°è‡ªåŠ¨é‡Šæ”¾æ‰€ç®¡ç†çš„èµ„æºï¼Œä»è€Œé¿å… `new/delete` é€ æˆçš„å†…å­˜æ³„æ¼ã€‚
>
> ä¸‰ç§å¸¸ç”¨æ™ºèƒ½æŒ‡é’ˆåŒºåˆ«å¦‚ä¸‹ï¼š
>
> - **`unique_ptr`**ï¼šç‹¬å æ‰€æœ‰æƒï¼Œç¦æ­¢æ‹·è´ï¼Œåªèƒ½ç§»åŠ¨ã€‚
> - **`shared_ptr`**ï¼šå…±äº«æ‰€æœ‰æƒï¼Œå†…éƒ¨ç”¨å¼•ç”¨è®¡æ•°æ§åˆ¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚
> - **`weak_ptr`**ï¼šå¼±å¼•ç”¨ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œç”¨æ¥æ‰“ç ´å¾ªç¯å¼•ç”¨å’Œè§‚å¯Ÿ `shared_ptr` æ‰€ç®¡ç†èµ„æºçš„çŠ¶æ€ã€‚
>
> å½“ä¸¤ä¸ª `shared_ptr` ç›¸äº’æŒæœ‰å¯¹æ–¹æ—¶ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œå¯¼è‡´å¯¹è±¡æ°¸è¿œä¸é‡Šæ”¾ï¼›æ­¤æ—¶ä¸€æ–¹åº”æ”¹ç”¨ `weak_ptr` è§£å†³ã€‚

------

## ğŸ§© æ™ºèƒ½æŒ‡é’ˆçš„åŸç†

C++ æ™ºèƒ½æŒ‡é’ˆæœ¬è´¨æ˜¯ä¸€ä¸ª**æ¨¡æ¿ç±»**ï¼Œå†…éƒ¨å°è£…äº†ä¸€ä¸ªåŸå§‹æŒ‡é’ˆï¼ˆ`T*`ï¼‰ï¼Œå¹¶åœ¨ææ„å‡½æ•°ä¸­è‡ªåŠ¨è°ƒç”¨ `delete` æˆ– `delete[]`ï¼ˆé»˜è®¤å®ç°ï¼‰ã€‚åŸç†åŸºäº **RAIIï¼ˆResource Acquisition Is Initializationï¼‰**ã€‚

ä¼˜ç‚¹ï¼š

- è‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼›
- è¯­ä¹‰æ¸…æ™°ï¼ˆæ‰€æœ‰æƒå¯è§ï¼‰ï¼›
- å¼‚å¸¸å®‰å…¨ã€‚

------

## ğŸ§± std::unique_ptr â€”â€” ç‹¬å æ‰€æœ‰æƒ

### âœ… ç‰¹ç‚¹

- ç‹¬å èµ„æºçš„æ‰€æœ‰æƒï¼›
- ç¦æ­¢æ‹·è´ï¼ˆé˜²æ­¢å¤šä¸ªæŒ‡é’ˆé‡Šæ”¾åŒä¸€å†…å­˜ï¼‰ï¼›
- å…è®¸ç§»åŠ¨ï¼ˆä½¿ç”¨ `std::move`ï¼‰ï¼›
- æ— å¼•ç”¨è®¡æ•°ï¼Œæ€§èƒ½æœ€é«˜ã€‚

### ğŸ’¡ åŸç†

å†…éƒ¨ä»…ä¿å­˜ä¸€ä¸ªåŸå§‹æŒ‡é’ˆ `T*`ï¼Œææ„æ—¶å¯¹å…¶è¿›è¡Œé”€æ¯ã€‚ç§»åŠ¨æ„é€ æ—¶è½¬ç§»æ‰€æœ‰æƒå¹¶ç½®ç©ºåŸæŒ‡é’ˆã€‚

### ğŸ§® ç®€åŒ–å®ç°

```cpp
template <typename T>
class unique_ptr {
    T* ptr;
public:
    explicit unique_ptr(T* p = nullptr) : ptr(p) {}
    
    ~unique_ptr() { 
        delete ptr; 
    }

    unique_ptr(unique_ptr&& other) noexcept : ptr(other.ptr) {
        other.ptr = nullptr;
    }

    unique_ptr& operator=(unique_ptr&& other) noexcept {
        if (this != &other) {
            delete ptr;
            ptr = other.ptr;
            other.ptr = nullptr;
        }
        return *this;
    }

    T* get() const { 
        return ptr; 
    }
    
    T& operator*() const { 
        return *ptr; 
    }
    
    T* operator->() const { 
        return ptr; 
    }
};
```

------

## ğŸ§® std::shared_ptr â€”â€” å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ

### âœ… ç‰¹ç‚¹

- å…è®¸å¤šä¸ª `shared_ptr` æŒ‡å‘åŒä¸€èµ„æºå¯¹è±¡ï¼›
- å†…éƒ¨é€šè¿‡æ§åˆ¶å—ï¼ˆControl Blockï¼‰ç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼›
- å½“ `use_count == 0` æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æºå¯¹è±¡ï¼›

### ğŸ’¡ åŸç†ï¼šç®€æ˜“æ§åˆ¶å—ç»“æ„

```text
Control Block {
  T* ptr;                  // æŒ‡å‘å®é™…èµ„æºå¯¹è±¡
  atomic<int> use_count;   // å…±äº«å¼•ç”¨è®¡æ•°
  atomic<int> weak_count;  // å¼±å¼•ç”¨è®¡æ•°
  Deleter deleter;         // åˆ é™¤å™¨ï¼ˆå¯ä»¥ä¸æŒ‡å®šï¼Œæœ‰é»˜è®¤å®ç°ï¼‰
}
```

æ‰€æœ‰ `shared_ptr` å…±äº«åŒä¸€æ§åˆ¶å—ã€‚

- `use_count == 0` â†’ èµ„æºå¯¹è±¡é”€æ¯ï¼›
- `use_count == 0 && weak_count == 0` â†’ æ§åˆ¶å—é”€æ¯ã€‚

### ğŸ’¬ ç”¨æ³•ç¤ºä¾‹

```cpp
#include <memory>

auto p1 = std::make_shared<int>(42);
{
    auto p2 = p1;
    std::cout << p1.use_count();  // è¾“å‡º 2
}
std::cout << p1.use_count();      // è¾“å‡º 1
```

### âš™ï¸ æ€§èƒ½è¯´æ˜

- å¼•ç”¨è®¡æ•°æ“ä½œæ˜¯åŸå­çš„ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ï¼Œæ“ä½œ `shared_ptr` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›
- æ¯” `unique_ptr` æ…¢ä¸€äº›ï¼›
- ä½¿ç”¨ `make_shared` èƒ½å‡å°‘ä¸€æ¬¡å†…å­˜åˆ†é…ï¼ˆå¯¹è±¡ä¸æ§åˆ¶å—åˆå¹¶åˆ†é…ï¼‰ã€‚

------

## ğŸ§  std::weak_ptr â€”â€” å¼±å¼•ç”¨ï¼ˆä¸æ‹¥æœ‰å¯¹è±¡ï¼‰

### âœ… ç‰¹ç‚¹

- ä¸å¢åŠ  `shared_ptr` çš„å¼•ç”¨è®¡æ•°ï¼›
- ä¸èƒ½ç›´æ¥è®¿é—®å¯¹è±¡ï¼›
- å¯é€šè¿‡ `lock()` è·å–ä¸´æ—¶çš„ `shared_ptr`ï¼›
- è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚

### ğŸ’¡ åŸç†

`weak_ptr` ä¹ŸæŒ‡å‘åŒä¸€æ§åˆ¶å—ï¼Œä½†åªå¢åŠ  `weak_count`ã€‚

### ğŸ’¬ ç”¨æ³•ç¤ºä¾‹

```cpp
#include <memory>
auto sp = std::make_shared<int>(5);
std::weak_ptr<int> wp = sp;

if (auto p = wp.lock()) {  // è·å–å…±äº«æ‰€æœ‰æƒ
    std::cout << *p << std::endl;
} else {
    std::cout << "object expired\n";
}
```

------

## ğŸš«å¾ªç¯å¼•ç”¨åŠè§£å†³æ–¹æ³•

### âš ï¸ é—®é¢˜ç¤ºä¾‹

```cpp
#include <memory>
#include <iostream>

struct B;
struct A {
    std::shared_ptr<B> bptr;
    ~A() { std::cout << "~A\n"; }
};
struct B {
    std::shared_ptr<A> aptr;
    ~B() { std::cout << "~B\n"; }
};

int main() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();
    a->bptr = b;
    b->aptr = a;
}
```

è¾“å‡ºï¼šæ²¡æœ‰ææ„å‡½æ•°è°ƒç”¨ï¼Œè¯´æ˜æ³„æ¼ã€‚åŸå› æ˜¯ä¸¤ä¸ª `shared_ptr` ç›¸äº’å¼•ç”¨ï¼Œ`use_count` æ°¸è¿œä¸ä¸º 0ã€‚

------

### âœ… è§£å†³æ–¹æ¡ˆ

```cpp
struct B;
struct A {
    std::shared_ptr<B> bptr;  // å¼ºå¼•ç”¨
    ~A() { std::cout << "~A\n"; }
};
struct B {
    std::weak_ptr<A> aptr;    // å¼±å¼•ç”¨
    ~B() { std::cout << "~B\n"; }
};

int main() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();
    a->bptr = b;
    b->aptr = a;  // ä¸å¢åŠ å¼•ç”¨è®¡æ•°
}
```

è¾“å‡ºï¼š

```
~A
~B
```

è§£é‡Šï¼š `weak_ptr` ä¸å½±å“ `use_count`ï¼Œæ‰€ä»¥ `A` å’Œ `B` å¯ä»¥æ­£ç¡®ææ„ã€‚

------

## ğŸ ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆå¯¹æ¯”æ€»ç»“

| ç‰¹æ€§     | `unique_ptr`     | `shared_ptr`     | `weak_ptr`         |
| -------- | ---------------- | ---------------- | ------------------ |
| æ‰€æœ‰æƒ   | ç‹¬å              | å…±äº«             | æ— æ‰€æœ‰æƒ           |
| å¼•ç”¨è®¡æ•° | âŒ æ—              | âœ… æœ‰             | âœ… ä»…å¼±è®¡æ•°         |
| æ‹·è´     | ç¦æ­¢             | å…è®¸             | å…è®¸               |
| ç§»åŠ¨     | å…è®¸             | å…è®¸             | å…è®¸               |
| è‡ªåŠ¨é‡Šæ”¾ | âœ…                | âœ…ï¼ˆæœ€åä¸€ä¸ªï¼‰    | âŒ                  |
| æ§åˆ¶å—   | æ—                | æœ‰               | ä¾é™„ `shared_ptr`  |
| æ€§èƒ½     | é«˜ï¼ˆæ— åŸå­æ“ä½œï¼‰ | è¾ƒä½ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ | è¾ƒé«˜ï¼ˆè½»é‡ï¼‰       |
| å…¸å‹åœºæ™¯ | ç‹¬å èµ„æºã€RAII   | å¤šå¤„å…±äº«èµ„æº     | è§‚å¯Ÿè€…æ¨¡å¼ã€æ‰“ç ´ç¯ |
